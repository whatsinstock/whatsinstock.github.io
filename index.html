<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Info Windows</title>
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }
        
        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        
        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <script>
      // redirect to https
      var loc = window.location.href+'';
      if (loc.indexOf('http://')==0){
          window.location.href = loc.replace('http://','https://');
      }
    </script>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>

<body>

    <div class="alert alert-success alert-dismissible" role="alert">
        Success! Thanks for helping fight basic supply shortages!
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <script>
        $(".alert").hide();
    </script>

    <div id="map"></div>
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Looks like you're at a grocery store. Mind helping us improve our data?</h4>
                </div>
                <div class="modal-body">
                    <!-- <form action="https://webhook.site/2ddcff16-9a3a-4a60-9033-499333c013e0" method="post"> -->
                    <form id="myForm">

                        <div class="form-group row">
                            <div class="col-sm-2">Store Name</div>
                            <div class="col-sm-10">
                                <input type="text" readonly class="form-control-plaintext" id="storeName" value="NoStore">
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm-2">Eggs</div>
                            <div class="col-sm-10">
                                <label class="radio-inline">
                                    <input type="radio" name="eggs" value="1">Out of Stock
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="eggs" value="2">Low on Stock
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="eggs" value="3">In Stock
                                </label>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm-2">Milk</div>
                            <div class="col-sm-10">
                                <label class="radio-inline">
                                    <input type="radio" name="milk" value="1">Out of Stock
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="milk" value="2">Low on Stock
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="milk" value="3">In Stock
                                </label>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm-2">Toilet Paper</div>
                            <div class="col-sm-10">
                                <label class="radio-inline">
                                    <input type="radio" name="tp" value="1">Out of Stock
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="tp" value="2">Low on Stock
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="tp" value="3">In Stock
                                </label>
                            </div>
                        </div>

                        <div class="form-group row" id="captcha">
                            <div class="col-sm-10">
                                <div class="g-recaptcha" data-sitekey="6LeN1-QUAAAAAEy5bqLIW3pIWd9IJ2S4f28uOvy_"></div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm-10">
                                <button type="submit" class="btn btn-primary">Send</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <script>
        $('#myForm').submit(function(e) {
            e.preventDefault();

            var recaptcha = $("#g-recaptcha-response").val();
            if (recaptcha === "") {
                $('#captcha').animate({
                    backgroundColor: '#FF0000'
                }, 0);
                $('#captcha').animate({
                    backgroundColor: '#FFFFFF'
                }, 'slow');
            } else {
                $.ajax({
                    url: 'https://webhook.site/2ddcff16-9a3a-4a60-9033-499333c013e0',
                    type: 'post',
                    data: "storeName=" + $('#storeName').val() + "&" + $('#myForm').serialize(),
                    success: function() {
                        console.log("success");
                        $('#myModal').modal('hide');

                        $(".alert").show();
                    }
                });
            }
        });
    </script>

    <script>
        function initMap() {

            const Http = new XMLHttpRequest();
            const url = "https://inventoryinformationbucket.s3.amazonaws.com/store_info.json";
            Http.open("GET", url, true);
            Http.send();

            Http.onreadystatechange = (e) => {
                var data = JSON.parse(Http.responseText);

                console.log(data);

                var center = {
                    lat: 40.868723,
                    lng: -73.873971
                };
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 10,
                    center: center
                });

                var cars = ["BMW", "Volvo", "Saab", "Ford", "Fiat", "Audi"];
                var i = 0;

                var contentStrings = [];
                var markers = [];

                var infowindow = new google.maps.InfoWindow({
                    content: "hi"
                });

                for (storeName in data) {
                    var address = data[storeName].Address;
                    var lat = data[storeName].lat;
                    var lng = data[storeName].lng;
                    var url = data[storeName].url;

                    var contentstring = `<h2>` + storeName + `</h2><a href="https://www.google.com/maps/search/?api=1&query=` + lat + `,` + lng + `">` + address + `</a><br><br>`

                    tableMiddle = ""
                    for (var idx = 0; idx < data[storeName].Products.length; idx++) {
                        var product_data = data[storeName].Products[idx]
                        tableMiddle = tableMiddle + `<tr><td>` + product_data[0] + `</td><td><font color="` + product_data[2] + `">` + product_data[1] + `</font></td></tr>`;
                    }

                    tableMiddle = `<table><tr>
              <th>Item</th>
              <th>Availability</th>
            </tr>` + tableMiddle + "</table>";

                    contentstring += tableMiddle;

                    console.log(contentstring);

                    var coord = {
                        lat: parseFloat(lat),
                        lng: parseFloat(lng)
                    }

                    console.log(coord);

                    var marker = new google.maps.Marker({
                        position: coord,
                        map: map,
                        title: storeName,
                        icon: {
                            url: url
                        },
                        info: contentstring

                    });

                  	marker.addListener('click', function(e) {
                        infowindow.setContent(this.info);
                        infowindow.open(map, this)
                    });

                    markers.push(marker);
                }

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(pos);

                        console.log(pos);

                        var min_dist = 99999999999999999;
                        var closestStore;

                        for (storeName in data) {
                            var lat = data[storeName].lat;
                            var lng = data[storeName].lng;

                            var dist = google.maps.geometry.spherical.computeDistanceBetween(
                                new google.maps.LatLng(pos.lat, pos.lng), new google.maps.LatLng(lat, lng)
                            );

                            console.log(dist);
                            if (dist < min_dist) {
                                min_dist = dist;
                                closestStore = storeName;
                            }
                        }

                        var threshold = 6999999999999999999999; //100
                        if (min_dist < threshold) {
                            $('#storeName').val(closestStore);
                            $('#myModal').modal('show');
                        }

                    });
                }

            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAb60HR2ZjXrhWc9EdWkzvKMMBt7AkfPNA&libraries=geometry&callback=initMap">
    </script>
</body>

</html>
